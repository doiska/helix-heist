# HELIX Heist test
Since the beginning of the test, I wrote down my thought process as I progressed. At the end of this document, you’ll find a summary of everything.

## Thoughts

### **Important**:
- For some reason, some of the server code was being sent to the client. I believe this is a bug, probably because encryption isn’t implemented yet.
- I only noticed this after moving shared/config.lua to server/config.lua, which now prevents users from knowing where the door, vault, etc. are through possible client code dumps.

### Data structure:
- ~~I couldn't find a unique id in the documentation, had the GetPlayerById, but no id. So I was storing the player name (found in HPlayer), but it's not possible to send a ClientEvent with that.~~ I'm now storing the HPlayer instance, but i'm not comfortable with this approach, since storing an "object" as key can lead to trick situations. I saw QBCore doing it, so I think it's fine. https://github.com/hypersonic-laboratories/qbcore-rp/blob/f3a0f0379e2b97570d72f74f65346adf8411cd92/qb-core/Server/player.lua#L20

### State Machine:
I used a straightforward implementation, which can be improved later.
By using canTransitionTo and validating state transitions, we prevent invalid changes.

States (in order of transition):
- IDLE -> Heist created but still waiting for players to join
- PREPARED -> Players have joined
- ENTRY -> Players begin the heist and now have to lockpick and initial actions
- VAULT_LOCKED -> Vault is reached but still closed, minigame starts
- VAULT_OPEN -> Puzzle solved, vault opens, police timer and vault closing countdown begin
- ESCAPE -> Vault closes, police arrives and players must escape within a configured zone and time limit
- COMPLETE -> All players successfully escape
- FAILED -> Any phase failure

- FAILED can occur from any state except IDLE.
- COMPLETE only occurs from ESCAPE after all players have left the area successfully.

### Data-exposing tradeoffs:
- ~~In the entry phase, the client-side has access to all door positions, thats because I couldn't find in the documentation a way to get player position server-side.~~ I implemented position check server-side, but kept the position client-side, because it's a trade-off choice, I think we'd be hurting user experience without much gain, by removing, for example, the possibility of waypoints in each door.

Loot:
- States
  - Players can start looting and stop (not collecting it)
  - Only 1 player can loot per loot spot
  - Loot spots can be collected by multiple players (configurable in loot settings)
- Considerations:
  - I thought that only the player should know how much they collected, but I think that everyone should know to coordinate better (like if someone has more money they should leave first) 

Minigame:
- Lockpick
  - I imagined lockpick as a circle, having "angles", units of distance.
  - It allowed me to generate a sequence of units, let's say [210, 120, 270, 135, 210], and based on that I can:
    - Make the lockpick "shake" as the user is getting closer to the angle
    - We'd have to display a shaking animation to work as lag compensation when the user triggers and makes the server request, this way we can make the request, wait for the response and the user wouldn't notice it
- Wordle (extra)
 - I tried to make something like wordle, especially with the UI (generated by bldr)
 - Turns out it was really fun and the countdown is a nice touch
 - The number seq generation and validation is completely server-side

Escape:
  - All players need to escape to mark the heist as completed - Enjoyable for both sides (police and robbers)

Explain what runs server-side:

- Minigame validation
- Loot generation
- Alarm triggers
  - The alarm has a chance to fire: silentAlarmChance and will be fired after silentAlarmDelayInSeconds seconds.
  - We only need to dispatch a event client-side for the participants if the LOUD alarm is fired (to spawn sfx) 

- PD alerts
 - PD gets alerted after a configurable period of time (policeAutoArriveInSeconds)
 - The department receives:
   - If the alarm was silent or loud
   - How many players are involved in the heist
   - The location of the bank (not players)

## Conclusion 

### Data Model

- The heist stores HPlayer instances for participants, required items, current state, timers (for alarm, vault closing, and police arrival), and loot configuration. 
- Locations (doors, vault, loot spots) are kept server-side and only exposed to the client at the relevant phase. Loot contents remain server-side until collected.

### State Machine

The heist follows a linear structure with validation:
- IDLE → PREPARED → ENTRY → VAULT_LOCKED → VAULT_OPEN → ESCAPE → COMPLETE
- FAILED can occur from any active phase, and if a player leaves during PREPARED, it resets to IDLE. All transitions are validated using canTransitionTo.

### Server Logic & Validation:
- All critical actions are fully handled server-side: minigame generation and validation, loot assignment, alarm triggers, PD notification, and state transitions. 
- The client ONLY triggers attempts and receives UI-related data. No client action directly determines outcome without server validation.

### Minigames
- Wordle-style: Players must guess a 4-number sequence. The server validates every attempt. Hints are based on correct/wrong digits and their positions. Failure occurs if the timer expires. TODO: Correct guesses add +5 seconds to reduce frustration.
- Lockpick: the server generates the sequence (angles). Client receives feedback (for example, lockpick “shakes” more as the player gets closer) to compensate for latency. Result accuracy is still validated server-side.

### PD Trigger:
Alarm can trigger based on silentAlarmChance after a delay. Separately, police are automatically notified after policeAutoArriveInSeconds. 
PD receives:
- Whether the alarm was silent or loud
- Number of players involved
- The bank location (not individual player locations)

### What is validated and what can’t trust the client?

- The client has no knowledge of where things are until they reach the phase. For example:
  - Entry: only knows where the door is (could be validated on server, but removes the ability of creating waypoints)
  - Vault Closed: vault door position
  - Vault Open: loot position, NOT the loot content. It's only aware of the alarm if it was a LOUD alarm, the silent has no client-side events.
- Minigame results: everything is handled server-side in heist-minigame.lua, the player only makes attempts
  - The client is aware of the progress, and only what will be displayed on their UI, nothing else.
  - All minigames uses "attempts" as TriggerCallback, validating only server-side.
- Loot: during the VAULT_OPEN phase, the player has no knowledge of what the loot items are, only the location.
- The player has no knowledge if the alarm was fired, unless it's a LOUD alarm, no event is sent.
- The client is only aware of their heist, no event is dispatched to all players, everything is handled by "broadcastEvent" in heist.lua


### Heist Flow

- Players will be presented with a lobby menu, where they can see a list of preparing heists and also create their own.

- Once a heist is created, it is automatically listed and other players can join it. 
  - The Leader can start the heist once the minPlayers requirement is met.

- When the heist starts, all players are teleported to the entrance and the state changes to ENTRY, 
  - This is when they begin lockpicking the main door and – in a roleplay scenario – taking hostages.

- After all doors are successfully lockpicked, the state changes to VAULT_LOCKED, when players finally reach the vault.
  - The vault has a single mechanic inspired by “Wordle”: players must guess a sequence of 4 numbers and receive hints based on incorrect digits or incorrect positions.

- Once they solve the puzzle, players gain access to the vault and the state changes to VAULT_OPEN. 
  - At this point, the police timer is started and the vault closing countdown also begins.

- When the vault closing time runs out, the state changes to ESCAPE and the police arrives, surrounding the area.
  - Players then have N seconds to escape the configured zone.
  - If all of them manage to exit within the time limit, the heist is considered successful.
  - If anyone fails, the heist is marked as failed.
